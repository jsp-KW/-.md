---

# 이체 기능 멱등성 + 동시성 제어 구현기 (Spring Boot + JPA)

## 문제 요약

* 금융 서비스의 핵심 기능인 **이체**에서, 동일 요청이 여러 번 들어오면 중복 처리될 위험이 있음
* 예: 네트워크 TIMEOUT, 버튼 연타, 브라우저 새로고침 → 동일 요청 20건 발생 시 모두 DB 반영
* 금전 거래에서 중복 반영은 치명적이므로 **멱등성(Idempotency)** 과 **동시성(Concurrency)** 제어 필요

---

## 원인 분석

| 항목         | 내용                          |
| ---------- | --------------------------- |
| 재시도 요청     | 사용자가 여러 번 같은 요청을 발송         |
| 네트워크/UX 문제 | TIMEOUT, 새로고침, 중복 클릭        |
| DB 무제한 처리  | 동일 요청이라도 모두 INSERT/UPDATE 됨 |
| 동시성 경쟁     | 동일 자원에 대한 여러 트랜잭션 충돌 가능성    |

* **멱등성 부재**: 동일 요청에 대해 결과가 여러 번 반영됨
* **동시성 제어 미비**: 동시에 처리 시 데이터 불일치 가능성
* **프론트/백엔드 간 키 공유 부재**: 요청 식별 불가

---

## 설계(오늘 구현한 부분에 대하여)

### Frontend

* **UUID v4 기반 Idempotency-Key 생성**
* 재시도/새로고침 시 같은 키 재사용 (`state` 또는 `localStorage` 저장)
* 요청 시 `Idempotency-Key`를 HTTP 헤더로 전송

### Backend

1. **UNIQUE 제약**: `transaction(request_id, type)` 컬럼에 UNIQUE 인덱스 적용
   → 동일 키 + 동일 타입(입금/출금) 중복 저장 방지
2. **낙관적 락(@Version)**: `account` 엔티티 버전 컬럼 적용
   → 동시 업데이트 시 1건만 성공, 나머지는 롤백
3. **중복 예외 처리**: `DataIntegrityViolationException` 발생 시 첫 응답과 동일하게 200 반환

---

## 시도한 검증 방법

```bash
# Postman에서 동일 키로 병렬 20건 요청
# Tests 탭에서 루프 돌리기
pm.sendRequest({
    url: 'http://localhost:8080/api/transfer',
    method: 'POST',
    header: {
        'Idempotency-Key': 'UUID-고정값'
    },
    body: {...}
}, function (err, res) { console.log(res.code) });
```

---

## 검증 결과

* HTTP 응답: **200 OK** × 20
* DB 트랜잭션: 출금 1건, 입금 1건만 반영
* 잔액 변화: 1회분만 적용
* `version` 컬럼: 해당 계좌에서 +1만 증가 (롤백된 요청 반영 없음)

---

## 보완 아이디어

1. **바디(payload) 비교**: 키가 같아도 요청 내용이 다르면 거절
2. **UUID 충돌 방지**: 사용자 ID + UUID 조합 사용
3. **Redis 캐시 관리**: 멱등키 TTL 저장 후 결과 캐싱 → DB 접근 없이 응답
4. **응답 정책 문서화**: 멱등키 TTL, 예외 응답 형식 규정
5. **Kafka 멱등성 옵션**: 메시지 큐 연동 시 중복 방지 기능 검토

---

## 깨달은 점

* 멱등성은 단순한 중복 방지가 아닌 **금융 서비스 신뢰성의 핵심 원칙**이다.
* DB 제약, 애플리케이션 예외 처리, 프론트 키 관리가 **유기적으로 맞물려야** 완벽히 보장됨
* 동시성 제어와 멱등성을 함께 구현하면, 실시간 대량 요청에도 안정성 확보 가능

---

## 회고

* 구현 전에는 단순히 이체기능 단일건에 대해서 잘 동작하고 넘어갔지만 생각을 해보니 금융도메인 특성상 보완해야할 점이 있음을 인지하였고
* 낙관락, 트랜잭션 격리수준에 대해서 공부하고 적용해보았다.
* 비관적락 분산락 여러 가지가 더 있어 공부를 추가적으로 더 한 후 업데이트를 할 예정이다.
* 20건 병렬 요청이 실제로 1회만 반영되는 것을 postman 자동화 스크립트 로직을 짜서 확인하였고 아직 추가적인 학습이 필요할 것 같다.
* 데이터베이스 과목을 공부하면서 배웠던 트랜잭션 관련 지식이 있어야 구현하며 흐름을 잘 캐치할 수 있는것 같다
* 추가적인 락관련해서 더욱 공부하여 이체기능에 대한 로직처리를 고도화할 것이다.
  

---

